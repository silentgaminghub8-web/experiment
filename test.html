<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App Builder</title>
    <style>
        /* --- RESET & BASIC SETUP --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        button {
            cursor: pointer;
            border: none;
            outline: none;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        /* --- MAIN HEADER (Fixed Overlay) --- */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #2d2d2d;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- ULTRA HEADER (Hidden by default) --- */
        #ultra-header {
            display: none; /* Hidden initially */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #330033; /* Distinct color for Ultra Mode */
            border-bottom: 1px solid #550055;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 1001; /* Higher than normal header */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header-left, .header-mid, .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Header Buttons Styling */
        .btn-header {
            background-color: #3c3c3c;
            color: white;
        }
        .btn-header:hover {
            background-color: #505050;
        }
        .btn-run { background-color: #0e639c; }
        .btn-run:hover { background-color: #1177bb; }
        .btn-live { background-color: #ce9178; color: #1e1e1e; font-weight: bold; }
        .btn-flash { background-color: #4caf50; }
        .btn-ultra { background-color: #6a1b9a; color: white; }
        .btn-ultra:hover { background-color: #8e24aa; }

        /* Ultra Header Buttons */
        .btn-ultra-action { background-color: #9c27b0; color: white; }
        .btn-ultra-back { background-color: #d32f2f; color: white; }
        .btn-ultra-update { background-color: #00897b; color: white; }
        
        .toggle-btn {
            background-color: #444;
            color: #aaa;
            border: 1px solid #555;
        }
        .toggle-btn.active {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        /* --- SUB-HEADER (Files) --- */
        #sub-header {
            position: fixed;
            top: 50px;
            left: 0;
            width: 100%;
            height: 35px;
            background-color: #252526;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 999;
            overflow-x: auto;
        }

        .file-tab {
            background-color: #2d2d2d;
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 13px;
            color: #cccccc;
            border-radius: 3px 3px 0 0;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .file-tab.active {
            background-color: #1e1e1e;
            border-top: 1px solid #0e639c;
            color: white;
        }
        .file-tab span { pointer-events: none; }
        .file-action-btn {
            font-size: 10px;
            padding: 2px;
            margin-left: 5px;
            background: transparent;
            color: #aaa;
        }
        .file-action-btn:hover { color: white; background: #444; }
        #add-file-btn {
            background: transparent;
            color: #ccc;
            font-size: 16px;
            padding: 0 10px;
        }

        /* --- CONTENT AREA --- */
        #main-container {
            margin-top: 85px; 
            height: calc(100vh - 85px);
            display: flex;
            position: relative;
            width: 100%;
        }

        /* Ultra Mode Container Adjustments */
        #main-container.ultra-mode {
            margin-top: 50px; /* Only Ultra Header visible */
            height: calc(100vh - 50px);
        }

        /* --- LEFT: CODE EDITOR --- */
        #editor-container {
            width: 50%;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            position: relative;
            min-width: 100px;
        }

        /* --- LEFT: ULTRA LAYER EDITOR (Initially Hidden) --- */
        #layer-editor-container {
            display: none; /* Hidden in normal mode */
            width: 50%;
            flex-direction: column;
            background-color: #252526;
            border-right: 1px solid #444;
            overflow: hidden;
        }
        
        .layer-header {
            padding: 10px;
            background: #333;
            color: #ddd;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        #layer-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .layer-item {
            padding: 5px 10px;
            margin-bottom: 2px;
            background: #2d2d2d;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .layer-item:hover { background: #3d3d3d; }
        .layer-item.active { background: #6a1b9a; color: white; }

        .layer-controls {
            display: flex;
            gap: 5px;
        }
        .layer-btn {
            font-size: 10px;
            padding: 2px 5px;
            background: #444;
            color: white;
        }

        /* --- COMMON EDITOR STYLES --- */
        .editor-body {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        #line-numbers {
            width: 40px;
            background-color: #1e1e1e;
            color: #858585;
            text-align: right;
            padding: 10px 5px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 20px;
            border-right: 1px solid #333;
            user-select: none;
            overflow: hidden;
        }

        #code-input {
            flex-grow: 1;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: none;
            resize: none;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 20px;
            outline: none;
            white-space: pre;
            overflow: auto;
        }

        #word-count-bar {
            height: 25px;
            background-color: #007acc;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            padding-left: 10px;
        }

        /* --- RESIZER --- */
        #resizer {
            width: 5px;
            background-color: #3e3e3e;
            cursor: col-resize;
            z-index: 10;
            transition: background 0.2s;
        }
        #resizer:hover, #resizer.resizing {
            background-color: #0e639c;
        }

        /* --- RIGHT: PREVIEW --- */
        #preview-container {
            flex-grow: 1;
            background-color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- FLASH OVERLAY --- */
        #flash-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 9999;
        }
        
        #flash-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff4444;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 5px;
            z-index: 10000;
        }

        #flash-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

    </style>
</head>
<body>

    <!-- NORMAL HEADER -->
    <div id="header">
        <div class="header-left">
            <button class="btn-header" id="btn-new">New Code</button>
        </div>
        <div class="header-mid">
            <button class="btn-header btn-run" id="btn-run">Run</button>
            <button class="btn-header btn-live" id="btn-live">Live: OFF</button>
            <button class="btn-header btn-ultra" id="btn-ultra">UltraEdit</button>
            <button class="btn-header" id="btn-copy">Copy</button>
        </div>
        <div class="header-right">
            <button class="btn-header btn-flash" id="btn-flash">Flash</button>
        </div>
    </div>

    <!-- ULTRA HEADER -->
    <div id="ultra-header">
        <div class="header-left">
            <button class="btn-header btn-ultra-back" id="btn-ultra-back">Back</button>
        </div>
        <div class="header-mid">
            <button class="btn-header btn-ultra-update" id="btn-ultra-update">Update & Save</button>
            <button class="btn-header toggle-btn" id="btn-ultra-action">Action: ON</button>
            <button class="btn-header btn-flash" id="btn-ultra-flash">Flash</button>
        </div>
        <div class="header-right">
            <button class="btn-header toggle-btn active" id="btn-ultra-edit-toggle">Edit Mode: ON</button>
        </div>
    </div>

    <!-- SUB-HEADER (Files) -->
    <div id="sub-header">
        <button id="add-file-btn" title="Add Page">+</button>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="main-container">
        <!-- 1. Code Editor (Normal Mode) -->
        <div id="editor-container">
            <div class="editor-body">
                <div id="line-numbers">1</div>
                <textarea id="code-input" spellcheck="false" placeholder="Enter your HTML code here..."></textarea>
            </div>
            <div id="word-count-bar">Total Words: 0</div>
        </div>

        <!-- 2. Layer Editor (Ultra Mode) -->
        <div id="layer-editor-container">
            <div class="layer-header">Layers (Select to Edit)</div>
            <div id="layer-list">
                <!-- Layers injected via JS -->
            </div>
        </div>

        <!-- Resizer -->
        <div id="resizer"></div>

        <!-- Preview -->
        <div id="preview-container">
            <iframe id="preview-frame"></iframe>
        </div>
    </div>

    <!-- Flash Overlay -->
    <div id="flash-overlay">
        <button id="flash-close-btn">Close Preview</button>
        <iframe id="flash-iframe"></iframe>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        let files = [
            { id: 1, name: 'index.html', content: '<h1>Hello World</h1>\n<p>Welcome to Ultra Edit.</p>\n<div style="width:100px; height:100px; background:red;">Box</div>' },
            { id: 2, name: 'style.css', content: 'body { padding: 20px; font-family: sans-serif; }' },
            { id: 3, name: 'script.js', content: 'console.log("Ready.");' }
        ];
        let currentFileId = 1;
        let isLive = false;
        let isUltraMode = false;
        let isUltraActionOn = true;
        let isUltraEditOn = true;

        // --- DOM ELEMENTS ---
        const header = document.getElementById('header');
        const subHeader = document.getElementById('sub-header');
        const ultraHeader = document.getElementById('ultra-header');
        const mainContainer = document.getElementById('main-container');
        
        const editorContainer = document.getElementById('editor-container');
        const layerEditorContainer = document.getElementById('layer-editor-container');
        
        const codeInput = document.getElementById('code-input');
        const lineNumbers = document.getElementById('line-numbers');
        const wordCountBar = document.getElementById('word-count-bar');
        const previewFrame = document.getElementById('preview-frame');
        const addFileBtn = document.getElementById('add-file-btn');
        const flashOverlay = document.getElementById('flash-overlay');
        const flashIframe = document.getElementById('flash-iframe');
        const resizer = document.getElementById('resizer');
        const layerList = document.getElementById('layer-list');

        // --- INIT ---
        function init() {
            renderTabs();
            loadCurrentFile();
            updateLineNumbers();
            updateWordCount();
            runPreview();
        }

        // --- NORMAL MODE LOGIC ---
        function renderTabs() {
            const tabs = subHeader.querySelectorAll('.file-tab');
            tabs.forEach(t => t.remove());

            files.forEach(file => {
                const tab = document.createElement('div');
                tab.className = `file-tab ${file.id === currentFileId ? 'active' : ''}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.innerText = file.name;
                tab.appendChild(nameSpan);

                nameSpan.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const newName = prompt("Rename file:", file.name);
                    if(newName && newName.trim() !== "") {
                        file.name = newName;
                        renderTabs();
                    }
                });

                const delBtn = document.createElement('button');
                delBtn.className = 'file-action-btn';
                delBtn.innerText = 'x';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteFile(file.id);
                };
                tab.appendChild(delBtn);

                tab.addEventListener('click', () => switchFile(file.id));
                subHeader.insertBefore(tab, addFileBtn);
            });
        }

        function switchFile(id) {
            if(!isUltraMode) {
                const currentFile = files.find(f => f.id === currentFileId);
                if(currentFile) currentFile.content = codeInput.value;
            }
            currentFileId = id;
            renderTabs();
            loadCurrentFile();
        }

        function loadCurrentFile() {
            const file = files.find(f => f.id === currentFileId);
            if(file) {
                codeInput.value = file.content;
                updateLineNumbers();
                updateWordCount();
            }
        }

        function deleteFile(id) {
            if(files.length <= 1) { alert("Cannot delete the last file."); return; }
            if(confirm("Are you sure?")) {
                const index = files.findIndex(f => f.id === id);
                files.splice(index, 1);
                if(currentFileId === id) currentFileId = files[0].id;
                renderTabs();
                loadCurrentFile();
            }
        }

        addFileBtn.addEventListener('click', () => {
            const name = prompt("File name:", "new.html");
            if(name) {
                const newId = Date.now();
                files.push({ id: newId, name: name, content: "" });
                renderTabs();
                switchFile(newId);
            }
        });

        // Editor Listeners
        codeInput.addEventListener('input', () => {
            updateLineNumbers();
            updateWordCount();
            if(isLive) runPreview();
        });
        codeInput.addEventListener('scroll', () => { lineNumbers.scrollTop = codeInput.scrollTop; });

        function updateLineNumbers() {
            const lines = codeInput.value.split('\n').length;
            lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
        }
        function updateWordCount() {
            const text = codeInput.value.trim();
            wordCountBar.innerText = `Total Words: ${text ? text.split(/\s+/).length : 0}`;
        }

        // --- PREVIEW GENERATION ---
        function getFullCode() {
            if(!isUltraMode) {
                const currentFile = files.find(f => f.id === currentFileId);
                if(currentFile) currentFile.content = codeInput.value;
            }

            let htmlContent = "";
            let cssContent = "";
            let jsContent = "";

            files.forEach(f => {
                if(f.name.endsWith('.html')) htmlContent += f.content + "\n";
                if(f.name.endsWith('.css')) cssContent += f.content + "\n";
                if(f.name.endsWith('.js')) jsContent += f.content + "\n";
            });

            return `
                <html>
                <head>
                    <style>${cssContent}</style>
                    <style>
                        /* Ultra Edit Helpers */
                        .ultra-selected {
                            outline: 2px solid #6a1b9a !important;
                            position: relative;
                            cursor: move;
                            z-index: 9999;
                            touch-action: none; /* Crucial for touch dragging */
                        }
                        .resize-handle {
                            position: absolute;
                            width: 20px;
                            height: 20px;
                            background: #6a1b9a;
                            bottom: -10px;
                            right: -10px;
                            cursor: se-resize;
                            z-index: 10000;
                            border-radius: 50%;
                            box-shadow: 0 0 5px rgba(0,0,0,0.5);
                            touch-action: none;
                        }
                        .rotate-handle {
                            position: absolute;
                            width: 20px;
                            height: 20px;
                            background: #00897b;
                            top: -25px;
                            left: 50%;
                            transform: translateX(-50%);
                            cursor: grab;
                            border-radius: 50%;
                            z-index: 10000;
                            box-shadow: 0 0 5px rgba(0,0,0,0.5);
                            touch-action: none;
                        }
                    </style>
                </head>
                <body>
                    ${htmlContent}
                    <script>
                        // --- ULTRA EDIT LOGIC INJECTION ---
                        window.isUltraEditOn = ${isUltraEditOn};
                        window.isUltraActionOn = ${isUltraActionOn};

                        // Use Pointer Events for unified Mouse/Touch handling
                        document.addEventListener('click', function(e) {
                            if(window.isUltraEditOn) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                if(!e.target.classList.contains('resize-handle') && 
                                   !e.target.classList.contains('rotate-handle')) {
                                    selectElement(e.target);
                                    window.parent.postMessage({ type: 'elementSelected', tag: e.target.tagName }, '*');
                                }
                            } else if (!window.isUltraActionOn) {
                                e.preventDefault();
                            }
                        }, true);

                        let currentSelection = null;
                        
                        function selectElement(el) {
                            if(currentSelection) {
                                currentSelection.classList.remove('ultra-selected');
                                const h = currentSelection.querySelector('.resize-handle');
                                if(h) h.remove();
                                const r = currentSelection.querySelector('.rotate-handle');
                                if(r) r.remove();
                            }
                            // Exclude root
                            if(el === document.body || el === document.documentElement) return;
                            
                            currentSelection = el;
                            el.classList.add('ultra-selected');
                            
                            // Add Handles
                            const resize = document.createElement('div');
                            resize.className = 'resize-handle';
                            el.appendChild(resize);
                            
                            const rotate = document.createElement('div');
                            rotate.className = 'rotate-handle';
                            el.appendChild(rotate);

                            // --- ATTACH POINTER EVENTS ---
                            // Note: We use pointerdown instead of mousedown/touchstart
                            el.onpointerdown = pointerDownDrag;
                            resize.onpointerdown = pointerDownResize;
                            rotate.onpointerdown = pointerDownRotate;
                        }

                        // --- ROBUST DRAG LOGIC (Pointer API) ---
                        let startX, startY, startLeft, startTop;

                        function pointerDownDrag(e) {
                            if(e.target.className.includes('handle')) return; // Ignore handles
                            if(!window.isUltraEditOn) return;

                            e.preventDefault(); 
                            e.stopPropagation();

                            // Capture the pointer so we don't lose the element if moving fast
                            e.target.setPointerCapture(e.pointerId);

                            startX = e.clientX;
                            startY = e.clientY;

                            // Force positioning context
                            const style = window.getComputedStyle(e.target);
                            if(style.position === 'static') {
                                e.target.style.position = 'relative';
                            }

                            // Calculate numeric starting positions
                            // We use offsets relative to the parent
                            startLeft = e.target.offsetLeft;
                            startTop = e.target.offsetTop;

                            e.target.onpointermove = pointerMoveDrag;
                            e.target.onpointerup = pointerUpDrag;
                            e.target.onpointercancel = pointerUpDrag;
                        }

                        function pointerMoveDrag(e) {
                            if(!currentSelection) return;
                            e.preventDefault();

                            const dx = e.clientX - startX;
                            const dy = e.clientY - startY;

                            currentSelection.style.left = (startLeft + dx) + "px";
                            currentSelection.style.top = (startTop + dy) + "px";
                        }

                        function pointerUpDrag(e) {
                            e.target.onpointermove = null;
                            e.target.onpointerup = null;
                            e.target.onpointercancel = null;
                            e.target.releasePointerCapture(e.pointerId);
                        }

                        // --- RESIZE LOGIC ---
                        let startW, startH;

                        function pointerDownResize(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.target.setPointerCapture(e.pointerId);

                            startX = e.clientX;
                            startY = e.clientY;
                            
                            const style = window.getComputedStyle(currentSelection);
                            startW = parseInt(style.width, 10) || 0;
                            startH = parseInt(style.height, 10) || 0;

                            e.target.onpointermove = pointerMoveResize;
                            e.target.onpointerup = pointerUpResize;
                        }

                        function pointerMoveResize(e) {
                            e.preventDefault();
                            const dx = e.clientX - startX;
                            const dy = e.clientY - startY;
                            currentSelection.style.width = (startW + dx) + 'px';
                            currentSelection.style.height = (startH + dy) + 'px';
                        }

                        function pointerUpResize(e) {
                            e.target.onpointermove = null;
                            e.target.onpointerup = null;
                            e.target.releasePointerCapture(e.pointerId);
                        }

                        // --- ROTATE LOGIC ---
                        function pointerDownRotate(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.target.setPointerCapture(e.pointerId);
                            
                            startX = e.clientX;
                            
                            e.target.onpointermove = pointerMoveRotate;
                            e.target.onpointerup = pointerUpRotate;
                        }

                        function pointerMoveRotate(e) {
                            e.preventDefault();
                            // Simple X-axis drag for rotation
                            const diff = e.clientX - startX;
                            currentSelection.style.transform = 'rotate(' + diff + 'deg)';
                        }

                        function pointerUpRotate(e) {
                            e.target.onpointermove = null;
                            e.target.onpointerup = null;
                            e.target.releasePointerCapture(e.pointerId);
                        }

                    <\/script>
                    <script>${jsContent}<\/script>
                </body>
                </html>
            `;
        }

        function runPreview() {
            const blob = new Blob([getFullCode()], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            previewFrame.src = url;
            flashIframe.src = url;

            previewFrame.onload = () => {
                if(isUltraMode) buildLayerList();
            };
        }

        // --- BUTTON HANDLERS ---
        document.getElementById('btn-new').addEventListener('click', () => {
            if(confirm("Clear everything?")) {
                codeInput.value = "";
                const currentFile = files.find(f => f.id === currentFileId);
                if(currentFile) currentFile.content = "";
                updateLineNumbers();
                updateWordCount();
                runPreview();
            }
        });

        document.getElementById('btn-run').addEventListener('click', runPreview);

        document.getElementById('btn-live').addEventListener('click', (e) => {
            isLive = !isLive;
            e.target.innerText = isLive ? "Live: ON" : "Live: OFF";
            e.target.style.background = isLive ? "#388e3c" : "#ce9178";
            e.target.style.color = isLive ? "white" : "#1e1e1e";
            if(isLive) runPreview();
        });

        document.getElementById('btn-copy').addEventListener('click', () => {
            codeInput.select();
            document.execCommand('copy');
            alert("Copied!");
        });

        function toggleFlash() {
            runPreview();
            flashOverlay.style.display = 'block';
        }
        document.getElementById('btn-flash').addEventListener('click', toggleFlash);
        document.getElementById('btn-ultra-flash').addEventListener('click', toggleFlash);
        document.getElementById('flash-close-btn').addEventListener('click', () => flashOverlay.style.display = 'none');


        // --- ULTRA EDIT LOGIC ---

        document.getElementById('btn-ultra').addEventListener('click', () => {
            isUltraMode = true;
            
            const currentFile = files.find(f => f.id === currentFileId);
            if(currentFile) currentFile.content = codeInput.value;

            header.style.display = 'none';
            subHeader.style.display = 'none';
            ultraHeader.style.display = 'flex';
            
            editorContainer.style.display = 'none';
            layerEditorContainer.style.display = 'flex';
            
            mainContainer.classList.add('ultra-mode');

            runPreview();
        });

        document.getElementById('btn-ultra-back').addEventListener('click', () => {
            if(confirm("Discard unsaved changes from Ultra Edit?")) {
                exitUltraMode();
            }
        });

        function exitUltraMode() {
            isUltraMode = false;
            header.style.display = 'flex';
            subHeader.style.display = 'flex';
            ultraHeader.style.display = 'none';
            
            editorContainer.style.display = 'flex';
            layerEditorContainer.style.display = 'none';
            
            mainContainer.classList.remove('ultra-mode');
            
            loadCurrentFile();
            runPreview();
        }

        document.getElementById('btn-ultra-update').addEventListener('click', () => {
            const doc = previewFrame.contentDocument;
            
            const selected = doc.querySelector('.ultra-selected');
            if(selected) {
                selected.classList.remove('ultra-selected');
                const h = selected.querySelectorAll('.resize-handle, .rotate-handle');
                h.forEach(el => el.remove());
            }

            let newHtml = doc.body.innerHTML;
            
            const splitScript = '<script>\n                        // --- ULTRA EDIT LOGIC INJECTION ---';
            if(newHtml.includes(splitScript)) {
                newHtml = newHtml.split(splitScript)[0];
            }
            newHtml = newHtml.replace(/<script>[\s\S]*?<\/script>$/i, ""); 

            const activeFile = files.find(f => f.id === currentFileId);
            let targetFile = activeFile.name.endsWith('.html') ? activeFile : files.find(f => f.name.endsWith('.html'));
            
            if(targetFile) {
                targetFile.content = newHtml.trim();
                alert("Changes saved to " + targetFile.name);
            } else {
                alert("No HTML file found to save content.");
            }

            exitUltraMode();
        });

        document.getElementById('btn-ultra-action').addEventListener('click', (e) => {
            isUltraActionOn = !isUltraActionOn;
            e.target.innerText = isUltraActionOn ? "Action: ON" : "Action: OFF";
            e.target.classList.toggle('active');
            runPreview();
        });

        document.getElementById('btn-ultra-edit-toggle').addEventListener('click', (e) => {
            isUltraEditOn = !isUltraEditOn;
            e.target.innerText = isUltraEditOn ? "Edit Mode: ON" : "Edit Mode: OFF";
            e.target.classList.toggle('active');
            runPreview();
        });

        // --- LAYER PANEL LOGIC ---
        function buildLayerList() {
            layerList.innerHTML = "";
            const doc = previewFrame.contentDocument;
            if(!doc || !doc.body) return;

            const allElements = doc.body.querySelectorAll('*');
            
            const visibleElements = Array.from(allElements).filter(el => 
                !el.classList.contains('resize-handle') && 
                !el.classList.contains('rotate-handle') &&
                el.tagName !== 'SCRIPT'
            );

            visibleElements.forEach((el, index) => {
                const item = document.createElement('div');
                item.className = 'layer-item';
                
                const label = document.createElement('span');
                label.innerText = `${el.tagName.toLowerCase()} ${el.id ? '#'+el.id : ''} ${el.className.replace('ultra-selected','').trim()}`;
                item.appendChild(label);

                const controls = document.createElement('div');
                controls.className = 'layer-controls';

                const btnUp = document.createElement('button');
                btnUp.className = 'layer-btn';
                btnUp.innerText = '↑';
                btnUp.onclick = (e) => {
                    e.stopPropagation();
                    if(el.previousElementSibling) {
                        el.parentNode.insertBefore(el, el.previousElementSibling);
                        buildLayerList();
                    }
                };

                const btnDown = document.createElement('button');
                btnDown.className = 'layer-btn';
                btnDown.innerText = '↓';
                btnDown.onclick = (e) => {
                    e.stopPropagation();
                    if(el.nextElementSibling) {
                        el.parentNode.insertBefore(el.nextElementSibling, el);
                        buildLayerList();
                    }
                };

                controls.appendChild(btnUp);
                controls.appendChild(btnDown);
                item.appendChild(controls);

                item.addEventListener('click', () => {
                    el.click(); // Trigger logic in iframe
                    document.querySelectorAll('.layer-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                });

                layerList.appendChild(item);
            });
        }

        window.addEventListener('message', (event) => {
            if (event.data.type === 'elementSelected') {
                // Future: Highlight layer list item based on event.data.tag
            }
        });

        // --- RESIZER LOGIC ---
        let isResizing = false;
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            previewFrame.style.pointerEvents = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = mainContainer.offsetWidth;
            const newLeftWidth = e.clientX;
            if (newLeftWidth > 100 && newLeftWidth < containerWidth - 100) {
                const percentage = (newLeftWidth / containerWidth) * 100;
                if(isUltraMode) {
                    layerEditorContainer.style.width = `${percentage}%`;
                } else {
                    editorContainer.style.width = `${percentage}%`;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if(isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = 'default';
                previewFrame.style.pointerEvents = 'auto';
            }
        });

        init();

    </script>
</body>
</html>
